<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TXT 报课记录管理</title>
<style>
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#f7f7f7;color:#111}
  .wrap{max-width:1000px;margin:24px auto;padding:0 16px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 4px 14px #0000000d;padding:16px;margin-bottom:16px}
  h1{margin:0 0 10px}
  input{padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px}
  .btn{padding:10px 14px;border:none;border-radius:10px;background:#0f766e;color:#fff;cursor:pointer}
  .btn.red{background:#dc2626}
  .btn.gray{background:#6b7280}
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid #e5e7eb;padding:8px;text-align:left;vertical-align:top}
  th{background:#f3f4f6}
  .muted{color:#6b7280}
  .rowhead{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#fee2e2;color:#991b1b;font-size:12px;margin-left:8px}
  .err{white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Consolas,monospace}
  .diag{font-family:ui-monospace,SFMono-Regular,Consolas,monospace;white-space:pre-wrap;background:#111;color:#e5e7eb;border-radius:10px;padding:12px;overflow:auto}
  .row{display:flex;gap:8px;flex-wrap:wrap}
</style>
</head>
<body>
<div class="wrap">

  <!-- 登录卡片 -->
  <div id="login" class="card">
    <h1>管理员登录</h1>
    <div class="row">
      <input id="u" placeholder="用户名" />
      <input id="p" type="password" placeholder="密码" />
      <button class="btn" onclick="login()">登录</button>
    </div>
    <div id="msg" class="muted" style="margin-top:8px"></div>
  </div>

  <!-- 列表面板 -->
  <div id="panel" style="display:none">
    <div class="card header">
      <h1>报课记录</h1>
      <div class="row">
        <button class="btn" onclick="loadList()">刷新</button>
        <button class="btn red" onclick="logout()">退出</button>
        <button class="btn gray" onclick="runDiag()">诊断</button>
      </div>
    </div>
    <div id="list"></div>
    <div id="diagBox" class="card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">网络诊断</h3>
        <button class="btn gray" onclick="toggleDiag(false)">关闭</button>
      </div>
      <div id="diagOut" class="diag" style="margin-top:8px"></div>
      <div class="muted" style="margin-top:8px">
        若看到 <code>TypeError: Failed to fetch</code>：通常是 URL 错 / 未发布为 Web App / 没给匿名访问 / 浏览器被 CORS 拦截。
      </div>
    </div>
  </div>
</div>

<script>
/* ========= 配置 ========= */
/* 把它改成你“已部署”的 Apps Script /exec URL */
const API_URL = 'https://script.google.com/macros/s/AKfycbzA_RVQlYKGuQCqBqA2X2gTBgSLENTwXWyQ60_6OdLi8TfFNHTDsTsyIE3TImxWtmFO/exec';

/* 登录占位提示（真实账号在 Apps Script 的 Script Properties） */
const PLACEHOLDER_USER = 'txtadmin';
const PLACEHOLDER_PASS = '202412';

/* token 存 sessionStorage */
const TOKEN_KEY = 'xanadu_admin_token';

document.getElementById('u').placeholder = `用户名（${PLACEHOLDER_USER}）`;
document.getElementById('p').placeholder = `密码（${PLACEHOLDER_PASS}）`;

/* ========= 工具 ========= */
const vstr = x => (x==null? '' : String(x));
function escapeHTML(s){
  return String(s==null?'':s).replace(/[&<>"']/g, c=>({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[c]));
}
const getToken  = ()=> sessionStorage.getItem(TOKEN_KEY)||'';
const setToken  = t => sessionStorage.setItem(TOKEN_KEY, t||'');
const clearToken= ()=> sessionStorage.removeItem(TOKEN_KEY);

/* 统一发请求 + 采集 status/response 文本，便于诊断 */
async function requestWithReport(url, init){
  const info = { url, method: (init&&init.method)||'GET' };
  try{
    const res  = await fetch(url, init);
    info.status = res.status;
    info.statusText = res.statusText;
    const text = await res.text();
    info.text = text.slice(0, 1200);
    let json;
    try{ json = JSON.parse(text); }catch{}
    return { ok: res.ok && json && json.ok===true, json: json||null, report: info };
  }catch(err){
    info.error = String(err);
    return { ok:false, json:null, report: info };
  }
}

/* ========= API ========= */
async function apiAuth(user, pass){
  return requestWithReport(API_URL, {
    method:'POST',
    headers:{ 'Content-Type':'text/plain;charset=utf-8' },
    body: JSON.stringify({ action:'auth', user, pass })
  });
}
async function apiList(token){
  const url = `${API_URL}?action=list&auth=${encodeURIComponent(token)}&_=${Date.now()}`;
  return requestWithReport(url, { method:'GET' });
}
async function apiDelete(ticket, token){
  return requestWithReport(API_URL, {
    method:'POST',
    headers:{ 'Content-Type':'text/plain;charset=utf-8' },
    body: JSON.stringify({ action:'delete', ticket, auth:token })
  });
}

/* ========= 登录 / 退出 ========= */
async function login(){
  const u = document.getElementById('u').value.trim();
  const p = document.getElementById('p').value.trim();
  document.getElementById('msg').textContent = '登录中…';

  const { ok, json, report } = await apiAuth(u, p);
  if(!ok){
    document.getElementById('msg').innerHTML =
      '授权失败：' + escapeHTML((json&&json.error)||report.statusText||report.error||'');
    showDiag(report, 'auth');
    return;
  }
  setToken(json.token || '');
  document.getElementById('login').style.display='none';
  document.getElementById('panel').style.display='block';
  loadList();
}
function logout(){
  clearToken();
  document.getElementById('panel').style.display='none';
  document.getElementById('login').style.display='block';
  document.getElementById('msg').textContent = '';
}

/* ========= 列表 ========= */
async function loadList(){
  const token = getToken();
  const box = document.getElementById('list');
  box.innerHTML = '<div class="card">加载中…</div>';
  if(!token){ box.innerHTML='<div class="card">未登录或口令失效，请重新登录。</div>'; logout(); return; }

  const { ok, json, report } = await apiList(token);
  if(!ok){
    if(json && /AUTH/i.test(json.error||'')){ box.innerHTML='<div class="card">口令无效或已过期，请重新登录。</div>'; logout(); return; }
    box.innerHTML = `<div class="card err">网络异常或接口错误：
URL: ${escapeHTML(report.url)}
Method: ${escapeHTML(report.method)}
Status: ${escapeHTML(String(report.status||''))} ${escapeHTML(report.statusText||'')}
Body: 
${escapeHTML(report.text||report.error||'')}
</div>`;
    showDiag(report, 'list');
    return;
  }

  const list = Array.isArray(json.data)? json.data : [];
  // 疑重：同姓名 +（同微信 或 同邮箱）
  const seen = new Map();
  for(const r of list){
    const k1 = `${vstr(r.name).trim()}|${vstr(r.wechat).trim()}`;
    const k2 = `${vstr(r.name).trim()}|${vstr(r.email).trim()}`;
    seen.set(k1,(seen.get(k1)||0)+1);
    seen.set(k2,(seen.get(k2)||0)+1);
  }
  const sorted = list.slice().sort((a,b)=>{
    const ta = new Date(vstr(a.ts)).getTime()||0;
    const tb = new Date(vstr(b.ts)).getTime()||0;
    return tb - ta;
  });
  const html = sorted.map(r=>{
    const name   = vstr(r.name).trim();
    const wechat = vstr(r.wechat).trim();
    const email  = vstr(r.email).trim();
    const phone  = vstr(r.phone).trim();
    const best   = vstr(r.best);
    const notes  = vstr(r.notes);
    const detail = vstr(r.detail);
    const ticket = vstr(r.ticket);
    const suspected = (seen.get(`${name}|${wechat}`)>1) || (seen.get(`${name}|${email}`)>1);
    const ts = r.ts ? new Date(vstr(r.ts)).toLocaleString() : '';

    return `
    <div class="card">
      <div class="rowhead">
        <div><b>咨询号码：</b>${escapeHTML(ticket)}${suspected?'<span class="badge">疑重</span>':''}</div>
        <button class="btn red" onclick="confirmDelete('${escapeHTML(ticket)}')">删除</button>
      </div>
      <table>
        <tr><th>客户姓名</th><td>${escapeHTML(name)}</td></tr>
        <tr><th>微信号</th><td>${escapeHTML(wechat || 'n/a')}</td></tr>
        <tr><th>邮箱</th><td>${escapeHTML(email)}</td></tr>
        <tr><th>电话</th><td>${escapeHTML(phone)}</td></tr>
        <tr><th>最佳匹配推荐</th><td>${escapeHTML(best)}</td></tr>
        <tr><th>备注</th><td>${escapeHTML(notes)}</td></tr>
        <tr><th>报课详细选项</th><td>${escapeHTML(detail)}</td></tr>
        <tr><th>时间</th><td class="muted">${escapeHTML(ts)}</td></tr>
      </table>
    </div>`;
  }).join('');
  box.innerHTML = html || '<div class="card">暂无记录</div>';
}

/* ========= 删除 ========= */
async function confirmDelete(ticket){
  const phrase = prompt('请再次确认是否删除该条记录？\n输入【确认删除】以继续，或点取消退出。');
  if(phrase===null) return;
  if(phrase.trim()!=='确认删除'){ alert('口令不正确，已取消删除。'); return; }

  const token = getToken();
  if(!token){ alert('未登录或口令失效，请重新登录。'); logout(); return; }

  const { ok, json, report } = await apiDelete(ticket, token);
  if(!ok){
    if(json && /AUTH/i.test(json.error||'')){ alert('口令无效或已过期，请重新登录。'); logout(); return; }
    alert(`删除失败：
Status: ${report.status||''} ${report.statusText||''}
Body: ${(report.text||report.error||'').slice(0,200)}`);
    showDiag(report, 'delete');
    return;
  }
  loadList();
}

/* ========= 诊断 ========= */
function toggleDiag(show){ document.getElementById('diagBox').style.display = show?'block':'none'; }
function showDiag(report, tag){
  toggleDiag(true);
  const out = [
    `# ${tag.toUpperCase()} 请求诊断`,
    `URL: ${report.url}`,
    `Method: ${report.method}`,
    `Status: ${report.status||''} ${report.statusText||''}`,
    `Error: ${report.error||''}`,
    `Body(first 1200 chars):`,
    `${report.text||''}`
  ].join('\n');
  document.getElementById('diagOut').textContent = out;
}
async function runDiag(){
  toggleDiag(true);
  const steps = [
    {name:'Ping',     fn:()=>requestWithReport(API_URL+'?pong=1', {method:'GET'})},
    {name:'ListGET',  fn:()=>requestWithReport(API_URL+'?action=list', {method:'GET'})}
  ];
  const out = [];
  for(const s of steps){
    out.push(`>>> ${s.name}`);
    try{
      const {ok, report} = await s.fn();
      out.push(`URL: ${report.url}`);
      out.push(`Status: ${report.status||''} ${report.statusText||''}`);
      out.push(`Body: ${ (report.text||report.error||'').slice(0,400) }`, '');
    }catch(e){
      out.push(String(e), '');
    }
  }
  document.getElementById('diagOut').textContent = out.join('\n');
}

/* ========= 自动进入 ========= */
(function init(){
  if(getToken()){
    document.getElementById('panel').style.display='block';
    loadList();
  }else{
    document.getElementById('login').style.display='block';
  }
})();
</script>
</body>
</html>
