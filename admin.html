<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TXT 报课咨询记录管理</title>
<style>
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#f7f7f7;color:#111}
  .wrap{max-width:1000px;margin:24px auto;padding:0 16px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 4px 14px #0000000d;padding:16px;margin-bottom:16px}
  h1{margin:0 0 10px}
  .btn{padding:10px 14px;border:none;border-radius:10px;background:#0f766e;color:#fff;cursor:pointer}
  .btn.red{background:#dc2626}
  .btn.warn{background:#fb923c;color:#111} /* 淡橙色按钮：待跟进 */
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid #e5e7eb;padding:8px;text-align:left;vertical-align:top}
  th{background:#f3f4f6}
  .muted{color:#6b7280}
  .rowhead{display:flex;gap:8px;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#fee2e2;color:#991b1b;font-size:12px;margin-left:8px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:12px}
  .pill.green{background:#dcfce7;color:#065f46;border:1px solid #bbf7d0}
  .err{white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Consolas,monospace}
  .google{margin-top:8px}
  .rowactions{display:flex;gap:8px;align-items:center}
</style>
</head>
<body>
<div class="wrap">

  <!-- 登录卡片 -->
  <div id="login" class="card">
    <h1>管理员登录</h1>
    <div class="muted">请使用<strong>被授权的 Google 账号</strong>登录。</div>
    <div id="gbtn" class="google"></div>
    <div id="msg" class="muted" style="margin-top:8px"></div>
  </div>

  <!-- 列表面板 -->
  <div id="panel" style="display:none">
    <div class="card header">
      <h1>报课记录</h1>
      <div style="display:flex;gap:8px">
        <button class="btn" onclick="loadList()">刷新</button>
        <button class="btn red" onclick="logout()">退出</button>
      </div>
    </div>
    <div id="list"></div>
  </div>

</div>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<script>
/* ============ 配置 ============ */
const API_URL = 'https://script.google.com/macros/s/AKfycbyR61yeZgHnp2TMX0IMozi4Ql8r2G7_l9yLR7LHfsYFu9asqvs0KXLeasgX40mEaZtn/exec';
const GOOGLE_CLIENT_ID = '126117723960-3gdibqblicp6ncc0jiuv9pu8frgmhs5n.apps.googleusercontent.com';
const SESSION_KEY = 'txt_admin_session';
const EMAIL_KEY   = 'txt_admin_email';

/* ============ 小工具 ============ */
const T = (v) => {              // 安全字符串化，避免 .trim 报错
  if (v == null) return '';
  if (Array.isArray(v)) return v.map(x => x == null ? '' : String(x)).join(', ').trim();
  try { return String(v).trim(); } catch { return ''; }
};
function esc(s){ return T(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) }
function getSession(){ return sessionStorage.getItem(SESSION_KEY) || ''; }
function setSession(v){ sessionStorage.setItem(SESSION_KEY, v||''); }
function getEmail(){ return sessionStorage.getItem(EMAIL_KEY) || ''; }
function setEmail(v){ sessionStorage.setItem(EMAIL_KEY, v||''); }
function clearSession(){ sessionStorage.removeItem(SESSION_KEY); sessionStorage.removeItem(EMAIL_KEY); }
function pad2(n){ return n<10 ? '0'+n : ''+n; }
function nowLocalDate(){ const d=new Date(); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
function nowLocalTime(){ const d=new Date(); return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`; }

/* ============ API ============ */
async function apiSignin(id_token){
  const res = await fetch(API_URL, {
    method:'POST',
    headers:{ 'Content-Type':'text/plain;charset=utf-8' },
    body: JSON.stringify({ action:'signin', id_token })
  });
  const text = await res.text();
  try{ return JSON.parse(text); }catch{ return { ok:false, error:'NOT_JSON', raw:text }; }
}
async function apiList(session){
  const res = await fetch(API_URL, {
    method:'POST',
    headers:{ 'Content-Type':'text/plain;charset=utf-8' },
    body: JSON.stringify({ action:'list', session })
  });
  const text = await res.text();
  try{ return JSON.parse(text); }catch{ return { ok:false, error:'NOT_JSON', raw:text }; }
}
async function apiDelete(session, ticket){
  const res = await fetch(API_URL, {
    method:'POST',
    headers:{ 'Content-Type':'text/plain;charset=utf-8' },
    body: JSON.stringify({ action:'delete', session, ticket })
  });
  const text = await res.text();
  try{ return JSON.parse(text); }catch{ return { ok:false, error:'NOT_JSON', raw:text }; }
}
async function apiFollow(session, ticket, by, date, time){
  const res = await fetch(API_URL, {
    method:'POST',
    headers:{ 'Content-Type':'text/plain;charset=utf-8' },
    body: JSON.stringify({ action:'follow', session, ticket, by, date, time })
  });
  const text = await res.text();
  try{ return JSON.parse(text); }catch{ return { ok:false, error:'NOT_JSON', raw:text }; }
}

/* ============ 登录 ============ */
window.onload = function(){
  window.google?.accounts.id.initialize({
    client_id: GOOGLE_CLIENT_ID,
    callback: onGoogleCredential,
    ux_mode: 'popup'
  });
  window.google?.accounts.id.renderButton(
    document.getElementById('gbtn'),
    { theme: 'outline', size: 'large', text: 'signin_with' }
  );

  if(getSession()){
    document.getElementById('panel').style.display='block';
    loadList();
  }else{
    document.getElementById('login').style.display='block';
  }
};

// Google 回调：拿到 id_token
async function onGoogleCredential(resp){
  const id_token = resp.credential;
  document.getElementById('msg').textContent = '正在验证…';
  try{
    const j = await apiSignin(id_token);
    if(!j.ok){
      document.getElementById('msg').textContent = '授权失败：' + (j.error||'');
      return;
    }
    setSession(j.session);
    setEmail(j.email || '');
    document.getElementById('login').style.display='none';
    document.getElementById('panel').style.display='block';
    loadList();
  }catch(err){
    document.getElementById('msg').textContent = '网络异常：' + String(err);
  }
}

function logout(){
  clearSession();
  document.getElementById('panel').style.display='none';
  document.getElementById('login').style.display='block';
  document.getElementById('msg').textContent = '';
}

/* ============ 列表 / 删除 / 跟进 ============ */
async function loadList(){
  const session = getSession();
  const box = document.getElementById('list');
  box.innerHTML = '<div class="card">加载中…</div>';
  if(!session){
    box.innerHTML = '<div class="card">未登录或口令失效，请重新登录。</div>';
    logout(); return;
  }

  try{
    const j = await apiList(session);

    // 先判断 ok，再渲染
    if(!j.ok){
      if(String(j.error||'').includes('AUTH')){
        box.innerHTML = '<div class="card">口令无效或已过期，请重新登录。</div>';
        logout(); return;
      }
      box.innerHTML = `<div class="card"><div><b>读取失败：</b>${esc(j.error||'')}</div>${j.raw?`<div class="err" style="margin-top:8px">${esc(j.raw)}</div>`:''}</div>`;
      return;
    }

    const list = Array.isArray(j.data) ? j.data : [];

    // 疑重标记：用 T() 规避非字符串
    const seen = new Map();
    for(const r of list){
      const key1 = `${T(r.name)}|${T(r.wechat)}`;
      const key2 = `${T(r.name)}|${T(r.email)}`;
      seen.set(key1,(seen.get(key1)||0)+1);
      seen.set(key2,(seen.get(key2)||0)+1);
    }

    const sorted = list.slice().sort((a,b)=>{
      const ta = new Date(T(a.ts) || 0).getTime()||0;
      const tb = new Date(T(b.ts) || 0).getTime()||0;
      return tb-ta;
    });

    const html = sorted.map(r=>{
      const name   = esc(T(r.name));
      const wc     = esc(T(r.wechat) || 'n/a');
      const em     = esc(T(r.email));
      const ph     = esc(T(r.phone));
      const best   = esc(T(r.best));
      const notes  = esc(T(r.notes));
      const detail = esc(T(r.detail));
      const ticket = esc(T(r.ticket));
      const key1   = `${T(r.name)}|${T(r.wechat)}`;
      const key2   = `${T(r.name)}|${T(r.email)}`;
      const suspected = (seen.get(key1)>1) || (seen.get(key2)>1);
      const ts = T(r.ts) ? new Date(T(r.ts)).toLocaleString() : '';

      const fby   = esc(T(r.follow_by));
      const fdate = esc(T(r.follow_date));
      const ftime = esc(T(r.follow_time));
      const followed = !!(T(r.follow_by) && T(r.follow_date) && T(r.follow_time));

      const actions = followed
        ? `<span class="pill green">✅ 已跟进 · ${fby} · ${fdate} ${ftime}</span>`
        : `<button class="btn warn" onclick="followUp('${ticket}')">待跟进</button>
           <button class="btn red" onclick="confirmDelete('${ticket}')">删除</button>`;

      return `
        <div class="card">
          <div class="rowhead">
            <div><b>咨询号码：</b>${ticket}${suspected?'<span class="badge">疑重</span>':''}</div>
            <div class="rowactions">${actions}</div>
          </div>
          <table>
            <tr><th>客户姓名</th><td>${name}</td></tr>
            <tr><th>微信号</th><td>${wc}</td></tr>
            <tr><th>邮箱</th><td>${em}</td></tr>
            <tr><th>电话</th><td>${ph}</td></tr>
            <tr><th>最佳匹配推荐</th><td>${best}</td></tr>
            <tr><th>备注</th><td>${notes}</td></tr>
            <tr><th>报课详细选项</th><td>${detail}</td></tr>
            <tr><th>时间</th><td class="muted">${esc(ts)}</td></tr>
            ${ followed ? `
              <tr><th>跟进人员</th><td>${fby}</td></tr>
              <tr><th>跟进日期</th><td>${fdate}</td></tr>
              <tr><th>跟进时间</th><td>${ftime}</td></tr>
            ` : '' }
          </table>
        </div>`;
    }).join('');
    box.innerHTML = html || '<div class="card">暂无记录</div>';

  }catch(err){
    document.getElementById('list').innerHTML = `<div class="card err">网络异常或接口错误：\n${esc(String(err))}</div>`;
  }
}

async function confirmDelete(ticket){
  const phrase = prompt('请再次确认是否删除该条记录？\n输入【确认删除】以继续，或点取消退出。');
  if(phrase===null) return;
  if(T(phrase)!=='确认删除'){ alert('口令不正确，已取消删除。'); return; }

  const session = getSession();
  if(!session){ alert('未登录或口令失效，请重新登录。'); logout(); return; }

  try{
    const j = await apiDelete(session, ticket);
    if(!j.ok){
      if(String(j.error||'').includes('AUTH')){ alert('口令无效或已过期，请重新登录。'); logout(); return; }
      alert('删除失败：' + (j.error||'')); return;
    }
    loadList();
  }catch(err){
    alert('网络异常，删除失败');
  }
}

/* 待跟进 -> 自动填充【当前登录邮箱 + 当前日期/时间】-> 二次确认口令【确认已跟进】 */
async function followUp(ticket){
  const session = getSession();
  const email = getEmail();
  if(!session){ alert('未登录或口令失效，请重新登录。'); logout(); return; }
  if(!email){ alert('未获取到当前登录邮箱，请重新登录后再试。'); logout(); return; }

  const okPhrase = prompt(
    `请再次确认是否已对该客户进行跟进？\n跟进人员：${email}\n跟进日期：${nowLocalDate()}\n跟进时间：${nowLocalTime()}\n\n输入【确认已跟进】以继续，或点取消退出。`
  );
  if(okPhrase===null) return;
  if(T(okPhrase)!=='确认已跟进'){ alert('口令不正确，已取消操作。'); return; }

  try{
    const j = await apiFollow(session, ticket, email, nowLocalDate(), nowLocalTime());
    if(!j.ok){
      if(String(j.error||'').includes('AUTH')){ alert('口令无效或已过期，请重新登录。'); logout(); return; }
      alert('提交失败：' + (j.error||'')); return;
    }
    loadList();
  }catch(err){
    alert('网络异常，请稍后再试');
  }
}
</script>
</body>
</html>
