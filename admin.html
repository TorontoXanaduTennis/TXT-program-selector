<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Xanadu 报课记录管理</title>
<style>
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#f7f7f7;color:#111}
  .wrap{max-width:1000px;margin:24px auto;padding:0 16px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 4px 14px #0000000d;padding:16px;margin-bottom:16px}
  h1{margin:0 0 10px}
  input{padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px}
  .btn{padding:10px 14px;border:none;border-radius:10px;background:#0f766e;color:#fff;cursor:pointer}
  .btn.red{background:#dc2626}
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid #e5e7eb;padding:8px;text-align:left;vertical-align:top}
  th{background:#f3f4f6}
  .muted{color:#6b7280}
  .rowhead{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
</style>
</head>
<body>
<div class="wrap">
  <!-- 登录卡片 -->
  <div id="login" class="card">
    <h1>管理员登录</h1>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <input id="u" placeholder="用户名" />
      <input id="p" type="password" placeholder="密码" />
      <button class="btn" onclick="login()">登录</button>
    </div>
    <div id="msg" class="muted" style="margin-top:8px"></div>
  </div>

  <!-- 列表面板 -->
  <div id="panel" style="display:none">
    <div class="card header">
      <h1>报课记录</h1>
      <div style="display:flex;gap:8px">
        <button class="btn" onclick="load()">刷新</button>
      </div>
    </div>
    <div id="list"></div>
  </div>
</div>

<script>
const STORAGE_KEY='xanadu_submissions';

// 登录
function login(){
  const u=document.getElementById('u').value.trim();
  const p=document.getElementById('p').value.trim();
  if(u==='txtadmin' && p==='202412'){
    document.getElementById('login').style.display='none';
    document.getElementById('panel').style.display='block';
    load();
  }else{
    document.getElementById('msg').textContent='授权失败';
  }
}

// 载入并渲染
function load(){
  const list=JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');

  // 疑重判断：同名 +（同微信 或 同邮箱）
  const seen=new Map();
  list.forEach(r=>{
    const k1=`${r.name}|${r.wechat||''}`;
    const k2=`${r.name}|${r.email||''}`;
    seen.set(k1,(seen.get(k1)||0)+1);
    seen.set(k2,(seen.get(k2)||0)+1);
  });

  // 最新在前
  const rows=list.slice().reverse().map(r=>{
    const suspected = (seen.get(`${r.name}|${r.wechat||''}`)>1) || (seen.get(`${r.name}|${r.email||''}`)>1);
    const ticketDisp = r.ticket + (suspected ? '（疑重）' : '');
    const ts = new Date(r.ts).toLocaleString();

    return `
    <div class="card">
      <div class="rowhead">
        <div><b>咨询号码：</b>${escapeHTML(ticketDisp)}</div>
        <button class="btn red" onclick="confirmDelete('${escapeAttr(r.ticket)}')">删除</button>
      </div>
      <table>
        <tr><th>客户姓名</th><td>${escapeHTML(r.name||'')}</td></tr>
        <tr><th>微信号</th><td>${escapeHTML(r.wechat||'n/a')}</td></tr>
        <tr><th>邮箱</th><td>${escapeHTML(r.email||'')}</td></tr>
        <tr><th>最佳匹配推荐</th><td>${escapeHTML(r.best||'')}</td></tr>
        <tr><th>备注</th><td>${escapeHTML(r.notes||'')}</td></tr>
        <tr><th>报课详细选项</th><td>${escapeHTML(r.detail||'')}</td></tr>
        <tr><th>时间</th><td class="muted">${escapeHTML(ts)}</td></tr>
      </table>
    </div>`;
  }).join('');

  document.getElementById('list').innerHTML = rows || '<div class="card">暂无记录</div>';
}

// 删除确认
function confirmDelete(ticket){
  const phrase = prompt('请再次确认是否删除该条记录？\n输入【确认删除】以继续，或点取消退出。');
  if(phrase===null) return; // 取消
  if(phrase.trim()!=='确认删除'){
    alert('口令不正确，已取消删除。');
    return;
  }
  deleteByTicket(ticket);
}

// 真正删除
function deleteByTicket(ticket){
  const list=JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');
  const next=list.filter(r=>r.ticket!==ticket);
  // 这里修复了引号错误
  localStorage.setItem(STORAGE_KEY, JSON.stringify(next));
  load();
}

// 转义工具
function escapeHTML(s){
  return String(s).replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
}
function escapeAttr(s){
  return String(s).replace(/['"\\]/g, c=>({'"':'&quot;',"'":'&#39;','\\':'\\\\'}[c]));
}
</script>
</body>
</html>
