<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TXT 报课记录管理 (Debug)</title>
<style>
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#f7f7f7;color:#111}
  .wrap{max-width:1000px;margin:24px auto;padding:0 16px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 4px 14px #0000000d;padding:16px;margin-bottom:16px}
  h1{margin:0 0 10px}
  input{padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px}
  .btn{padding:10px 14px;border:none;border-radius:10px;background:#0f766e;color:#fff;cursor:pointer}
  .btn.red{background:#dc2626}
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid #e5e7eb;padding:8px;text-align:left;vertical-align:top}
  th{background:#f3f4f6}
  .muted{color:#6b7280}
  .rowhead{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#fee2e2;color:#991b1b;font-size:12px;margin-left:8px}
  .err{white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Consolas,monospace}
</style>
</head>
<body>
<div class="wrap">

  <!-- 登录卡片 -->
  <div id="login" class="card">
    <h1>管理员登录</h1>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <input id="u" placeholder="用户名" />
      <input id="p" type="password" placeholder="密码" />
      <button class="btn" onclick="login()">登录</button>
    </div>
    <div id="msg" class="muted" style="margin-top:8px"></div>
  </div>

  <!-- 列表面板 -->
  <div id="panel" style="display:none">
    <div class="card header">
      <h1>报课记录</h1>
      <div style="display:flex;gap:8px">
        <button class="btn" onclick="loadList()">刷新</button>
        <button class="btn red" onclick="logout()">退出</button>
      </div>
    </div>
    <div id="list"></div>
  </div>
</div>

<script>
/* ============ 配置 ============ */
const API_URL = 'https://script.google.com/macros/s/AKfycbyc-Jva3yKKS-0bUhfCopluaAdT1J089H9RbipoczjJZWxXvG-jFnhEx7_oEIUWrd6q/exec';
const TOKEN_KEY = 'xanadu_admin_token';

/* ============ 工具 ============ */
function vstr(x){ return (x===undefined||x===null) ? '' : String(x); }
function escapeHTML(s){ return String(s==null?'':s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function getToken(){ const t = sessionStorage.getItem(TOKEN_KEY)||''; console.log("DEBUG getToken:",t); return t; }
function setToken(t){ console.log("DEBUG setToken:",t); sessionStorage.setItem(TOKEN_KEY,t||''); }
function clearToken(){ sessionStorage.removeItem(TOKEN_KEY); }

/* ============ API ============ */
async function apiAuth(user, pass){
  console.log("DEBUG 调用 auth:", user, pass);
  const res = await fetch(API_URL, {
    method:'POST',
    headers:{ 'Content-Type':'text/plain;charset=utf-8' },
    body: JSON.stringify({ action:'auth', user, pass })
  });
  const text = await res.text();
  console.log("DEBUG auth response text:", text);
  try{ return JSON.parse(text); }
  catch{ return { ok:false, error:'NOT_JSON', raw:text.slice(0,500) }; }
}

async function apiList(token){
  const url = `${API_URL}?action=list&auth=${encodeURIComponent(token)}&_=${Date.now()}`;
  console.log("DEBUG list 请求 URL:", url);
  const res = await fetch(url,{method:'GET'});
  const text = await res.text();
  console.log("DEBUG list response text:", text);
  try{
    if(text.startsWith("cb(")){ // JSONP 兼容
      return JSON.parse(text.slice(3,-2));
    }
    return JSON.parse(text);
  }catch{
    return { ok:false, error:'NOT_JSON', raw:text.slice(0,500) };
  }
}

async function apiDelete(ticket, token){
  console.log("DEBUG delete ticket:", ticket);
  const res = await fetch(API_URL, {
    method:'POST',
    headers:{ 'Content-Type':'text/plain;charset=utf-8' },
    body: JSON.stringify({ action:'delete', ticket, auth:token })
  });
  const text = await res.text();
  console.log("DEBUG delete response:", text);
  try{ return JSON.parse(text); }
  catch{ return { ok:false, error:'NOT_JSON', raw:text.slice(0,500) }; }
}

/* ============ 登录逻辑 ============ */
async function login(){
  const u=document.getElementById('u').value.trim();
  const p=document.getElementById('p').value.trim();
  document.getElementById('msg').textContent='登录中…';
  try{
    const j = await apiAuth(u,p);
    if(!j.ok){ document.getElementById('msg').textContent='授权失败:'+ (j.error||''); return; }
    setToken(j.token||'');
    document.getElementById('login').style.display='none';
    document.getElementById('panel').style.display='block';
    loadList();
  }catch(err){
    document.getElementById('msg').textContent='网络异常:'+err;
  }
}
function logout(){ clearToken(); document.getElementById('panel').style.display='none'; document.getElementById('login').style.display='block'; }

/* ============ 列表 ============ */
async function loadList(){
  const token=getToken();
  const box=document.getElementById('list');
  if(!token){ box.innerHTML='<div class="card">未登录</div>'; return; }
  box.innerHTML='<div class="card">加载中…</div>';
  const j=await apiList(token);
  if(!j.ok){ box.innerHTML=`<div class="card">读取失败:${escapeHTML(j.error||'')}</div>`; return; }
  const list=Array.isArray(j.data)?j.data:[];
  box.innerHTML=list.map(r=>`
    <div class="card">
      <div class="rowhead"><b>咨询号码：</b>${escapeHTML(r.ticket||'')}</div>
      <table>
        <tr><th>客户姓名</th><td>${escapeHTML(r.name||'')}</td></tr>
        <tr><th>微信号</th><td>${escapeHTML(r.wechat||'n/a')}</td></tr>
        <tr><th>邮箱</th><td>${escapeHTML(r.email||'')}</td></tr>
        <tr><th>电话</th><td>${escapeHTML(r.phone||'')}</td></tr>
        <tr><th>最佳匹配推荐</th><td>${escapeHTML(r.best||'')}</td></tr>
        <tr><th>备注</th><td>${escapeHTML(r.notes||'')}</td></tr>
        <tr><th>报课详细选项</th><td>${escapeHTML(r.detail||'')}</td></tr>
        <tr><th>时间</th><td>${escapeHTML(r.ts||'')}</td></tr>
      </table>
    </div>`).join('') || '<div class="card">暂无记录</div>';
}

/* ============ 初始化 ============ */
(function init(){
  if(getToken()){ document.getElementById('login').style.display='none'; document.getElementById('panel').style.display='block'; loadList(); }
})();
</script>
</body>
</html>
