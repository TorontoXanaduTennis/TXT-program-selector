<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TXT 报课记录管理</title>
<style>
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#f7f7f7;color:#111}
  .wrap{max-width:1000px;margin:24px auto;padding:0 16px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 4px 14px #0000000d;padding:16px;margin-bottom:16px}
  h1{margin:0 0 10px}
  input{padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px}
  .btn{padding:10px 14px;border:none;border-radius:10px;background:#0f766e;color:#fff;cursor:pointer}
  .btn.red{background:#dc2626}
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid #e5e7eb;padding:8px;text-align:left;vertical-align:top}
  th{background:#f3f4f6}
  .muted{color:#6b7280}
  .rowhead{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#fee2e2;color:#991b1b;font-size:12px;margin-left:8px}
  .err{white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Consolas,monospace}
</style>
</head>
<body>
<div class="wrap">

  <!-- 登录卡片 -->
  <div id="login" class="card" style="display:none">
    <h1>管理员登录</h1>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <input id="u" placeholder="用户名（txtadmin）" />
      <input id="p" type="password" placeholder="密码（202412）" />
      <button class="btn" onclick="login()">登录</button>
    </div>
    <div id="msg" class="muted" style="margin-top:8px"></div>
  </div>

  <!-- 列表面板 -->
  <div id="panel" style="display:none">
    <div class="card header">
      <h1>报课记录</h1>
      <div style="display:flex;gap:8px">
        <button class="btn" onclick="loadList()">刷新</button>
        <button class="btn red" onclick="logout()">退出</button>
      </div>
    </div>
    <div id="list"></div>
  </div>
</div>

<script>
/* ============ 配置（务必改成你“最新部署”的 /exec 链接） ============ */
const API_URL = 'https://script.google.com/macros/s/AKfycbxtv5e_Sk3vJpMhmAku9UP7tisdnsmN_zG00_8p7OTRqwfJ3ojS5E53AUAoPB3reToG/exec';
const PLACEHOLDER_USER = 'txtadmin';
const PLACEHOLDER_PASS = '202412';
const TOKEN_KEY = 'xanadu_admin_token';

/* ============ 小工具 ============ */
const vstr = x => (x==null ? '' : String(x));
function escapeHTML(s){ return String(s==null?'':s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
const getToken = () => sessionStorage.getItem(TOKEN_KEY) || '';
const setToken = t => sessionStorage.setItem(TOKEN_KEY, t||'');
const clearToken = () => sessionStorage.removeItem(TOKEN_KEY);

/* ============ 健康检查（能最快定位“Failed to fetch”的根因） ============ */
async function apiPing(){
  try{
    const r = await fetch(API_URL + '?pong=1&_=' + Date.now(), { method:'GET', cache:'no-store' });
    const t = await r.text();
    try{ return JSON.parse(t); }catch{ return { ok:false, error:'NOT_JSON', raw:t.slice(0,200) }; }
  }catch(err){
    return { ok:false, error:'FETCH_ERROR', raw:String(err) };
  }
}

/* ============ API 封装 ============ */
// 认证：POST {action:'auth', user, pass} => {ok:true, token}
async function apiAuth(user, pass){
  const res = await fetch(API_URL, {
    method:'POST',
    headers:{ 'Content-Type':'text/plain;charset=utf-8' }, // 避免预检
    body: JSON.stringify({ action:'auth', user, pass }),
    cache:'no-store'
  });
  const text = await res.text();
  try{ return JSON.parse(text); }
  catch{ return { ok:false, error:'NOT_JSON', raw:text.slice(0,800) }; }
}

// 列表：GET /exec?action=list&auth=TOKEN
async function apiList(token){
  const url = `${API_URL}?action=list&auth=${encodeURIComponent(token)}&_=${Date.now()}`;
  const res = await fetch(url, { method:'GET', cache:'no-store' });
  const text = await res.text();
  if(!res.ok) return { ok:false, error:`HTTP ${res.status}`, raw:text.slice(0,800) };
  try{ return JSON.parse(text); }
  catch{ return { ok:false, error:'NOT_JSON', raw:text.slice(0,800) }; }
}

// 删除：POST {action:'delete', ticket, auth:TOKEN}
async function apiDelete(ticket, token){
  const res = await fetch(API_URL, {
    method:'POST',
    headers:{ 'Content-Type':'text/plain;charset=utf-8' },
    body: JSON.stringify({ action:'delete', ticket, auth:token }),
    cache:'no-store'
  });
  const text = await res.text();
  try{ return JSON.parse(text); }
  catch{ return { ok:false, error:'NOT_JSON', raw:text.slice(0,800) }; }
}

/* ============ 登录 / 退出 ============ */
async function login(){
  const u = document.getElementById('u').value.trim();
  const p = document.getElementById('p').value.trim();
  document.getElementById('msg').textContent = '登录中…';

  try{
    const j = await apiAuth(u, p);
    if(!j.ok){
      document.getElementById('msg').textContent = '授权失败：' + (j.error||'');
      return;
    }
    setToken(j.token || '');
    document.getElementById('login').style.display='none';
    document.getElementById('panel').style.display='block';
    loadList();
  }catch(err){
    document.getElementById('msg').textContent = '网络异常：' + String(err);
  }
}

function logout(){
  clearToken();
  document.getElementById('panel').style.display='none';
  document.getElementById('login').style.display='block';
  document.getElementById('msg').textContent = '';
}

/* ============ 列表渲染 ============ */
async function loadList(){
  const token = getToken();
  const box = document.getElementById('list');
  box.innerHTML = '<div class="card">加载中…</div>';

  if(!token){
    box.innerHTML = '<div class="card">未登录或口令失效，请重新登录。</div>';
    logout();
    return;
  }

  try{
    const j = await apiList(token);
    if(!j.ok){
      if(String(j.error||'').includes('AUTH')){
        box.innerHTML = '<div class="card">口令无效或已过期，请重新登录。</div>';
        logout(); return;
      }
      box.innerHTML = `
        <div class="card">
          <div><b>读取失败：</b>${escapeHTML(j.error||'')}</div>
          ${j.raw ? `<div class="err" style="margin-top:8px">${escapeHTML(j.raw)}</div>` : ''}
        </div>`;
      return;
    }

    const list = Array.isArray(j.data) ? j.data : [];

    // 疑重（同名 + 同微信/邮箱）
    const seen = new Map();
    for(const r of list){
      const k1 = `${vstr(r.name).trim()}|${vstr(r.wechat).trim()}`;
      const k2 = `${vstr(r.name).trim()}|${vstr(r.email).trim()}`;
      seen.set(k1,(seen.get(k1)||0)+1);
      seen.set(k2,(seen.get(k2)||0)+1);
    }

    // 时间倒序
    const sorted = list.slice().sort((a,b)=>{
      const ta = new Date(vstr(a.ts)).getTime()||0;
      const tb = new Date(vstr(b.ts)).getTime()||0;
      return tb - ta;
    });

    const html = sorted.map(r=>{
      const name   = vstr(r.name).trim();
      const wechat = vstr(r.wechat).trim();
      const email  = vstr(r.email).trim();
      const phone  = vstr(r.phone).trim();
      const best   = vstr(r.best);
      const notes  = vstr(r.notes);
      const detail = vstr(r.detail);
      const ticket = vstr(r.ticket);
      const suspected = (seen.get(`${name}|${wechat}`)>1) || (seen.get(`${name}|${email}`)>1);
      const ts = r.ts ? new Date(vstr(r.ts)).toLocaleString() : '';

      return `
      <div class="card">
        <div class="rowhead">
          <div><b>咨询号码：</b>${escapeHTML(ticket)}${suspected?'<span class="badge">疑重</span>':''}</div>
          <button class="btn red" onclick="confirmDelete('${escapeHTML(ticket)}')">删除</button>
        </div>
        <table>
          <tr><th>客户姓名</th><td>${escapeHTML(name)}</td></tr>
          <tr><th>微信号</th><td>${escapeHTML(wechat || 'n/a')}</td></tr>
          <tr><th>邮箱</th><td>${escapeHTML(email)}</td></tr>
          <tr><th>电话</th><td>${escapeHTML(phone)}</td></tr>
          <tr><th>最佳匹配推荐</th><td>${escapeHTML(best)}</td></tr>
          <tr><th>备注</th><td>${escapeHTML(notes)}</td></tr>
          <tr><th>报课详细选项</th><td>${escapeHTML(detail)}</td></tr>
          <tr><th>时间</th><td class="muted">${escapeHTML(ts)}</td></tr>
        </table>
      </div>`;
    }).join('');

    box.innerHTML = html || '<div class="card">暂无记录</div>';
  }catch(err){
    // 只有真正网络层失败才会进这里（比如 /exec 链接错误、未公开、被跳转拦截）
    // 顺手做个 ping，给出更明确的提示
    const ping = await apiPing();
    const more = ping.ok ? '' : `\n[健康检查] ${ping.error}${ping.raw ? ' - ' + ping.raw : ''}`;
    document.getElementById('list').innerHTML =
      `<div class="card err">网络异常或接口错误：\n${escapeHTML(String(err))}${escapeHTML(more)}</div>`;
  }
}

/* ============ 删除 ============ */
async function confirmDelete(ticket){
  const phrase = prompt('请再次确认是否删除该条记录？\n输入【确认删除】以继续，或点取消退出。');
  if(phrase===null) return;
  if(phrase.trim()!=='确认删除'){ alert('口令不正确，已取消删除。'); return; }

  const token = getToken();
  if(!token){ alert('未登录或口令失效，请重新登录。'); logout(); return; }

  try{
    const j = await apiDelete(ticket, token);
    if(!j.ok){
      if(String(j.error||'').includes('AUTH')){ alert('口令无效或已过期，请重新登录。'); logout(); return; }
      alert('删除失败：' + (j.error||'')); return;
    }
    loadList();
  }catch(err){
    alert('网络异常，删除失败');
  }
}

/* ============ 初始化 ============ */
(async function init(){
  document.getElementById('u').placeholder = `用户名（${PLACEHOLDER_USER}）`;
  document.getElementById('p').placeholder = `密码（${PLACEHOLDER_PASS}）`;

  // 先做一次 ping，能提前发现“Failed to fetch”的根因
  const ping = await apiPing();
  if(!ping.ok){
    document.getElementById('login').style.display='block';
    document.getElementById('msg').innerHTML =
      '无法访问 Apps Script 接口：<br>' +
      '<div class="err">' + escapeHTML(ping.error + (ping.raw?(' - '+ping.raw):'')) + '</div>' +
      '<div class="muted" style="margin-top:6px">请检查：1) API_URL 是否为最新部署的 /exec；2) 部署访问权限是否选 “Anyone”；3) 重新部署后是否复制了新的 URL。</div>';
    return;
  }

  if(getToken()){
    document.getElementById('panel').style.display='block';
    loadList();
  }else{
    document.getElementById('login').style.display='block';
  }
})();
</script>
</body>
</html>
