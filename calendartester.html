<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>日历 · Google Calendar（含只读展示、多日历）</title>

  <!-- FullCalendar CSS 多源回退 -->
  <link id="fc-css" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.min.css" rel="stylesheet" />
  <script>
    // 如果首个 CSS 5 秒内没加载到，自动切换备用 CDN
    (function ensureFullCalendarCSS(){
      function loaded(sheet){
        try { return !!sheet.sheet && sheet.sheet.cssRules !== null; } catch(e){ return !!sheet.sheet; }
      }
      function swap(){
        const l=document.getElementById('fc-css');
        const tried = l.getAttribute('data-tried')||'';
        if(!tried.includes('jsdelivr')){
          l.href="https://unpkg.com/fullcalendar@6.1.19/index.min.css";
          l.setAttribute('data-tried', tried+' jsdelivr');
          setTimeout(swap, 4000);
        } else if(!tried.includes('unpkg')){
          l.href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.9/index.min.css";
          l.setAttribute('data-tried', tried+' unpkg');
        }
      }
      setTimeout(function(){
        const l=document.getElementById('fc-css');
        if(!loaded(l)) swap();
      }, 5000);
    })();
  </script>

  <!-- FullCalendar v6 JS -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>

  <!-- Google Identity Services + Google API JS -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>

  <style>
    :root { --border:#e5e7eb; --bg:#f8fafc; --text:#111827; --muted:#6b7280; }
    * { box-sizing: border-box; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center;padding:10px 14px;z-index:10}
    #calendar{max-width:1100px;margin:16px auto;padding:0 12px}
    button{padding:8px 12px;border:1px solid var(--border);border-radius:8px;background:#fff;cursor:pointer}
    .right{margin-left:auto;display:flex;gap:8px;align-items:center}
    .help{font-size:12px;color:var(--muted)}
    .footer{max-width:1100px;margin:16px auto;padding:0 12px 24px;color:#6b7280;font-size:12px}
    .title{font-weight:600;margin-right:6px}
    select{padding:6px 8px;border:1px solid var(--border);border-radius:8px;background:#fff}
    .panel{max-width:1100px;margin:10px auto 0;padding:8px 12px;border:1px solid var(--border);background:#fff;border-radius:10px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
    .pill{display:flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:2px 8px;background:#fff;font-size:12px}
    .sw{width:10px;height:10px;border-radius:3px;border:1px solid #00000022}
    .list{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
    .item{display:flex;align-items:center;gap:6px;font-size:12px;border:1px dashed var(--border);padding:3px 8px;border-radius:8px;background:#fff}
    .item input{transform:translateY(1px)}
    .diag{max-width:1100px;margin:8px auto 0;padding:8px 12px;border:1px dashed var(--border);background:#fff;border-radius:10px;color:#374151}
    .diag b{color:#111}
    .diag pre{white-space:pre-wrap;word-break:break-word;margin:6px 0 0;font-size:12px;color:#6b7280}
    .stats{max-width:1100px;margin:8px auto 0;padding:6px 12px;font-size:12px;color:#374151}
    .stats code{background:#fff;border:1px solid var(--border);padding:2px 6px;border-radius:8px;margin-right:6px;display:inline-block}
  </style>
</head>
<body>
  <header>
    <span class="title">日历</span>
    <div class="right">
      <button id="signin">使用 Google 登录</button>
      <button id="signout" style="display:none;">退出</button>
      <button id="refreshBtn" style="display:none;">刷新</button>
      <span id="status" class="help">未登录</span>
    </div>
  </header>

  <!-- 选择显示哪些日历（包含只读） -->
  <div id="picker" class="panel" style="display:none;">
    <div class="row">
      <div class="help">选择要显示的日历（可多选；只读也可显示）：</div>
      <button id="checkAll" class="help" style="border:1px solid var(--border);background:#fff;border-radius:8px;">全选</button>
      <button id="uncheckAll" class="help" style="border:1px solid var(--border);background:#fff;border-radius:8px;">全不选</button>
      <select id="writeCal" title="写入目标（只列可写）" style="display:none;"></select>
      <div class="help">写入目标：<code id="currCal">primary</code></div>
    </div>
    <div id="calList" class="list"></div>
    <div class="legend" id="legend"></div>
  </div>

  <div id="calendar"></div>

  <!-- 轻量调试面板：当前视图内每一天的事件数量 -->
  <div class="stats" id="stats" style="display:none;"></div>

  <div class="diag" id="diag" style="display:none;">
    <b>诊断</b>
    <pre id="diagText"></pre>
  </div>

  <div class="footer">
    <div>时区：<code id="tzLabel">America/Toronto</code></div>
    <p class="help">说明：只读日历会显示但不可编辑；写入只落在“写入目标”所选日历。</p>
  </div>

  <script>
    // 你的 Web Client ID
    const CLIENT_ID = "126117723960-3gdibqblicp6ncc0jiuv9pu8frgmhs5n.apps.googleusercontent.com";
    // 最小必要 Scope
    const SCOPES = "https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/calendar.events";
    // 展示用时区
    const TIMEZONE = "America/Toronto";
    // 抓取窗口缓冲（毫秒）：前后各 +36 小时，覆盖 DST/跨日边界
    const FETCH_BUFFER_MS = 36 * 60 * 60 * 1000;

    let tokenClient, accessToken=null, gapiReady=false, gisReady=false, calendar;
    let calendarListCache=[];          // 可见日历（含只读）
    let showCalendarIds=new Set();     // 勾选显示的日历
    let writeCalendarId="primary";     // 写入目标

    function showDiag(obj){const b=document.getElementById('diag');const p=document.getElementById('diagText');b.style.display='';try{p.textContent=(typeof obj==='string')?obj:JSON.stringify(obj,null,2);}catch(e){p.textContent=String(obj);} }

    function gapiLoaded(){gapi.load('client', async ()=>{await gapi.client.init({discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"]}); gapiReady=true;});}
    window.gapiLoaded=gapiLoaded;

    function gisLoaded(){tokenClient=google.accounts.oauth2.initTokenClient({
      client_id:CLIENT_ID, scope:SCOPES,
      callback:(resp)=>{ if(resp&&resp.access_token){ accessToken=resp.access_token; gapi.client.setToken({access_token:accessToken}); onSignedIn(); } else { showDiag({oauth_callback_resp:resp}); } }
    }); gisReady=true;}
    window.gisLoaded=gisLoaded;

    async function signIn(){ if(!gapiReady||!gisReady) return; tokenClient.requestAccessToken({prompt:'consent'}); }
    function signOut(){ if(!accessToken) return; google.accounts.oauth2.revoke(accessToken,()=>{
      accessToken=null; gapi.client.setToken(null);
      document.getElementById('signin').style.display=''; document.getElementById('signout').style.display='none';
      document.getElementById('refreshBtn').style.display='none'; document.getElementById('status').textContent='未登录';
      document.getElementById('writeCal').style.display='none'; document.getElementById('picker').style.display='none';
      document.getElementById('stats').style.display='none';
      if(calendar) calendar.destroy();
    });}
    document.getElementById('signin').onclick=signIn;
    document.getElementById('signout').onclick=signOut;
    document.getElementById('refreshBtn').onclick=()=>{ if(calendar) calendar.refetchEvents(); };
    document.getElementById('tzLabel').textContent=TIMEZONE;

    async function onSignedIn(){
      document.getElementById('signin').style.display='none';
      document.getElementById('signout').style.display=''; document.getElementById('refreshBtn').style.display='';
      document.getElementById('status').textContent='已登录';

      try{
        const res=await gapi.client.calendar.calendarList.list({maxResults:250});
        calendarListCache=(res.result.items||[]);

        // 写入目标（只列可写）
        const writeSel=document.getElementById('writeCal'); writeSel.innerHTML='';
        const writable=calendarListCache.filter(c=>c.accessRole==='owner'||c.accessRole==='writer');
        for(const cal of writable){ const opt=document.createElement('option'); opt.value=cal.id; opt.textContent=cal.summary+(cal.primary?" (primary)":""); writeSel.appendChild(opt); }
        const primary=writable.find(c=>c.primary);
        writeCalendarId=primary?primary.id:(writable[0]?.id||'primary');
        writeSel.value=writeCalendarId; document.getElementById('currCal').textContent=writeCalendarId; writeSel.style.display='';
        writeSel.onchange=()=>{ writeCalendarId=writeSel.value; document.getElementById('currCal').textContent=writeCalendarId; };

        // 多选显示（默认全选）
        const picker=document.getElementById('picker'); const listDiv=document.getElementById('calList'); const legend=document.getElementById('legend');
        listDiv.innerHTML=''; legend.innerHTML=''; showCalendarIds=new Set(calendarListCache.map(c=>c.id));
        for(const cal of calendarListCache){
          const wrap=document.createElement('label'); wrap.className='item';
          const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=true; cb.value=cal.id;
          cb.onchange=()=>{ if(cb.checked) showCalendarIds.add(cal.id); else showCalendarIds.delete(cal.id); if(calendar) calendar.refetchEvents(); };
          const sw=document.createElement('span'); sw.className='sw'; sw.style.background=cal.backgroundColor||'#bbb';
          const txt=document.createElement('span'); txt.textContent=cal.summary+(cal.accessRole==='reader'?'（只读）':'');
          wrap.appendChild(cb); wrap.appendChild(sw); wrap.appendChild(txt); listDiv.appendChild(wrap);

          const pill=document.createElement('span'); pill.className='pill';
          const sw2=document.createElement('span'); sw2.className='sw'; sw2.style.background=cal.backgroundColor||'#bbb';
          const name=document.createElement('span'); name.textContent=cal.summary;
          pill.appendChild(sw2); pill.appendChild(name); legend.appendChild(pill);
        }
        picker.style.display='';

        document.getElementById('checkAll').onclick=()=>{ showCalendarIds=new Set(calendarListCache.map(c=>c.id)); listDiv.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=true); if(calendar) calendar.refetchEvents(); };
        document.getElementById('uncheckAll').onclick=()=>{ showCalendarIds=new Set(); listDiv.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=false); if(calendar) calendar.refetchEvents(); };

      }catch(e){ showDiag(e); }

      renderCalendar();
    }

    function renderCalendar(){
      const el=document.getElementById('calendar'); if(calendar) calendar.destroy();

      calendar=new FullCalendar.Calendar(el,{
        initialView:'timeGridWeek',
        timeZone:TIMEZONE,
        firstDay:1,
        slotMinTime:"08:00:00",
        slotMaxTime:"23:59:59",
        scrollTime:"08:00:00",
        slotLabelFormat:{hour:'2-digit',minute:'2-digit',hour12:false}, // 24h
        selectable:true,
        editable:true,
        nowIndicator:true,
        headerToolbar:{ left:'prev,next today', center:'title', right:'dayGridMonth,timeGridWeek,timeGridDay' },

        events: async (info, success, failure)=>{
          try{
            // —— 加缓冲窗口，覆盖周日深夜/跨日/DST —— 
            const timeMinISO=new Date(info.start.getTime()-FETCH_BUFFER_MS).toISOString();
            const timeMaxISO=new Date(info.end.getTime()+FETCH_BUFFER_MS).toISOString();
            const ids=(showCalendarIds.size?Array.from(showCalendarIds):[writeCalendarId]);

            const fetchOne=async(cid)=>{
              const res=await gapi.client.calendar.events.list({
                calendarId:cid,
                timeMin:timeMinISO, timeMax:timeMaxISO,
                singleEvents:true, orderBy:'startTime', showDeleted:false, maxResults:2500,
              });
              const meta=calendarListCache.find(x=>x.id===cid);
              const color=meta?.backgroundColor;
              const canEdit=meta && (meta.accessRole==='owner'||meta.accessRole==='writer');

              return (res.result.items||[]).map(ev=>({
                id:(ev.id||Math.random().toString(36).slice(2))+'::'+cid, // 防跨日历冲突
                title:ev.summary||'(无标题)',
                start:ev.start.dateTime||ev.start.date,
                end:ev.end?.dateTime||ev.end?.date,
                allDay:!!ev.start.date,
                backgroundColor:color, borderColor:color,
                extendedProps:{calendarId:cid, eventId:ev.id, canEdit}
              }));
            };

            const chunks=await Promise.all(ids.map(cid=>fetchOne(cid)));
            const events=chunks.flat();

            // —— 在前端按视窗精确裁剪 + 输出统计 —— 
            const viewStart=info.start.getTime(), viewEnd=info.end.getTime();
            const filtered=events.filter(ev=>{
              const s=new Date(ev.start).getTime();
              const e=ev.end ? new Date(ev.end).getTime() : s;
              return e>viewStart && s<viewEnd;
            });

            // 调试统计：显示一周七天的数量（Sun=0 ... Sat=6）
            const buckets=[0,0,0,0,0,0,0];
            filtered.forEach(ev=>{
              const d=new Date(ev.start); buckets[d.getDay()]++;
            });
            const stats=document.getElementById('stats');
            stats.style.display='';
            stats.innerHTML = `
              <code>Sun:${buckets[0]}</code>
              <code>Mon:${buckets[1]}</code>
              <code>Tue:${buckets[2]}</code>
              <code>Wed:${buckets[3]}</code>
              <code>Thu:${buckets[4]}</code>
              <code>Fri:${buckets[5]}</code>
              <code>Sat:${buckets[6]}</code>
            `;

            success(filtered);
          }catch(err){ showDiag(err); failure(err); }
        },

        eventAllow:(dropInfo, draggedEvent)=>{
          const canEdit=draggedEvent.extendedProps?.canEdit;
          if(!canEdit){ alert('这是只读日历的事件，不能编辑。'); return false; }
          return true;
        },

        select: async (selInfo)=>{
          const title=prompt('事件标题：','新事件');
          if(!title){ calendar.unselect(); return; }
          const isAllDay=selInfo.allDay;
          const resource={
            summary:title,
            start:isAllDay?{date:selInfo.startStr}:{dateTime:selInfo.startStr,timeZone:TIMEZONE},
            end:  isAllDay?{date:selInfo.endStr}:{dateTime:selInfo.endStr,timeZone:TIMEZONE},
          };
          try{
            const res=await gapi.client.calendar.events.insert({calendarId:writeCalendarId, resource});
            const ev=res.result;
            const meta=calendarListCache.find(x=>x.id===writeCalendarId);
            const color=meta?.backgroundColor;
            if(showCalendarIds.has(writeCalendarId)){
              calendar.addEvent({
                id:(ev.id||Math.random().toString(36).slice(2))+'::'+writeCalendarId,
                title:ev.summary||'(无标题)',
                start:ev.start.dateTime||ev.start.date,
                end:ev.end?.dateTime||ev.end?.date,
                allDay:!!ev.start.date,
                backgroundColor:color, borderColor:color,
                extendedProps:{calendarId:writeCalendarId, eventId:ev.id, canEdit:true}
              });
            }
          }catch(e){ showDiag(e); alert('创建失败：'+(e.result?.error?.message||e.message)); }
        },

        eventChange: async (chg)=>{
          const e=chg.event;
          const {calendarId,eventId,canEdit}=e.extendedProps||{};
          if(!canEdit){ chg.revert(); return; }
          try{
            await gapi.client.calendar.events.update({
              calendarId,eventId,
              resource:{
                summary:e.title,
                start:e.allDay?{date:e.startStr}:{dateTime:e.start.toISOString(),timeZone:TIMEZONE},
                end:  e.allDay?{date:e.endStr}:{dateTime:e.end?.toISOString(),timeZone:TIMEZONE},
              }
            });
          }catch(err){ showDiag(err); alert('更新失败，已回滚：'+(err.result?.error?.message||err.message)); chg.revert(); }
        },

        eventClick: async (clickInfo)=>{
          const {calendarId,eventId,canEdit}=clickInfo.event.extendedProps||{};
          if(!canEdit){ alert('这是只读日历的事件，不能删除。'); return; }
          if(!confirm('删除这个事件？')) return;
          try{
            await gapi.client.calendar.events.delete({calendarId,eventId});
            clickInfo.event.remove();
            calendar.refetchEvents();
          }catch(err){ showDiag(err); alert('删除失败：'+(err.result?.error?.message||err.message)); }
        }
      });

      calendar.render();
    }

    window.onload=()=>{ if(window.gapi) gapiLoaded(); if(window.google) gisLoaded(); };
  </script>
</body>
</html>
