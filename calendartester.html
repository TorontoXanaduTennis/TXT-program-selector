<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>内部用 · Google Calendar（含只读展示、多日历）</title>

  <!-- FullCalendar v6 -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>

  <!-- Google Identity Services + Google API JS -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>

  <style>
    :root { --border:#e5e7eb; --bg:#f8fafc; --text:#111827; --muted:#6b7280; }
    * { box-sizing: border-box; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center;padding:10px 14px;z-index:10}
    #calendar{max-width:1100px;margin:16px auto;padding:0 12px}
    button{padding:8px 12px;border:1px solid var(--border);border-radius:8px;background:#fff;cursor:pointer}
    .right{margin-left:auto;display:flex;gap:8px;align-items:center}
    .help{font-size:12px;color:var(--muted)}
    .footer{max-width:1100px;margin:16px auto;padding:0 12px 24px;color:var(--muted);font-size:12px}
    .chip{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;background:#fff;font-size:12px;color:#374151}
    .title{font-weight:600;margin-right:6px}
    select{padding:6px 8px;border:1px solid var(--border);border-radius:8px;background:#fff}
    .panel{max-width:1100px;margin:10px auto 0;padding:8px 12px;border:1px solid var(--border);background:#fff;border-radius:10px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
    .pill{display:flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:2px 8px;background:#fff;font-size:12px}
    .sw{width:10px;height:10px;border-radius:3px;border:1px solid #00000022}
    .list{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
    .item{display:flex;align-items:center;gap:6px;font-size:12px;border:1px dashed var(--border);padding:3px 8px;border-radius:8px;background:#fff}
    .item input{transform:translateY(1px)}
    .diag{max-width:1100px;margin:8px auto 0;padding:8px 12px;border:1px dashed var(--border);background:#fff;border-radius:10px;color:#374151}
    .diag b{color:#111}
    .diag pre{white-space:pre-wrap;word-break:break-word;margin:6px 0 0;font-size:12px;color:#6b7280}
  </style>
</head>
<body>
  <header>
    <span class="title">内部日历</span>
    <span class="chip">纯前端 · GitHub Pages</span>
    <div class="right">
      <button id="signin">使用 Google 登录</button>
      <button id="signout" style="display:none;">退出</button>
      <span id="status" class="help">未登录</span>
      <select id="writeCal" title="写入目标（只列可写）" style="display:none;"></select>
    </div>
  </header>

  <!-- 选择显示哪些日历（包含只读） -->
  <div id="picker" class="panel" style="display:none;">
    <div class="row">
      <div class="help">选择要显示的日历（可多选；只读也可显示）：</div>
      <button id="checkAll" class="help" style="border:1px solid var(--border);background:#fff;border-radius:8px;">全选</button>
      <button id="uncheckAll" class="help" style="border:1px solid var(--border);background:#fff;border-radius:8px;">全不选</button>
      <div class="help">写入目标：<code id="currCal">primary</code></div>
    </div>
    <div id="calList" class="list"></div>
    <div class="legend" id="legend"></div>
  </div>

  <div id="calendar"></div>

  <div class="diag" id="diag" style="display:none;">
    <b>诊断</b>
    <pre id="diagText"></pre>
  </div>

  <div class="footer">
    <div>时区：<code id="tzLabel">America/Toronto</code></div>
    <p class="help">说明：只读日历会显示但不可编辑；写入只落在右上角“写入目标”所选日历。删除/更新均与 Google Calendar 强一致同步。</p>
  </div>

  <script>
    // 替换为你的 Google Web Client ID（Web 应用）
    const CLIENT_ID = "126117723960-3gdibqblicp6ncc0jiuv9pu8frgmhs5n.apps.googleusercontent.com";

    // 读取所有可见日历 + 写事件（最小必要组合）
    const SCOPES = "https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/calendar.events";

    const TIMEZONE = "America/Toronto";

    let tokenClient, accessToken = null, gapiReady = false, gisReady = false, calendar;
    let calendarListCache = []; // 所有“可见”的日历（含只读）
    let showCalendarIds = new Set(); // 当前“勾选用于显示”的日历ID集合（含只读）
    let writeCalendarId = "primary"; // 写入目标（只列可写）

    // —— 工具：诊断输出 ——
    function showDiag(obj) {
      const box = document.getElementById('diag');
      const pre = document.getElementById('diagText');
      box.style.display = '';
      try { pre.textContent = (typeof obj === 'string') ? obj : JSON.stringify(obj, null, 2); }
      catch(e) { pre.textContent = String(obj); }
    }

    // —— GAPI/GIS 初始化 ——
    function gapiLoaded() {
      gapi.load('client', async () => {
        await gapi.client.init({ discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"] });
        gapiReady = true;
      });
    }
    window.gapiLoaded = gapiLoaded;

    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (resp) => {
          if (resp && resp.access_token) {
            accessToken = resp.access_token;
            gapi.client.setToken({ access_token: accessToken }); // 把 token 灌进 gapi
            onSignedIn();
          } else {
            showDiag({ oauth_callback_resp: resp });
          }
        },
      });
      gisReady = true;
    }
    window.gisLoaded = gisLoaded;

    async function signIn() {
      if (!gapiReady || !gisReady) return;
      tokenClient.requestAccessToken({ prompt: 'consent' });
    }
    function signOut() {
      if (!accessToken) return;
      google.accounts.oauth2.revoke(accessToken, () => {
        accessToken = null;
        gapi.client.setToken(null);
        document.getElementById('signin').style.display = '';
        document.getElementById('signout').style.display = 'none';
        document.getElementById('status').textContent = '未登录';
        document.getElementById('writeCal').style.display = 'none';
        document.getElementById('picker').style.display = 'none';
        if (calendar) calendar.destroy();
      });
    }
    document.getElementById('signin').onclick = signIn;
    document.getElementById('signout').onclick = signOut;
    document.getElementById('tzLabel').textContent = TIMEZONE;

    // —— 登录后：拉日历列表，构建“写入目标 + 多选显示清单” ——
    async function onSignedIn() {
      document.getElementById('signin').style.display = 'none';
      document.getElementById('signout').style.display = '';
      document.getElementById('status').textContent = '已登录';

      try {
        const res = await gapi.client.calendar.calendarList.list({ maxResults: 250 });
        calendarListCache = (res.result.items || []);

        // 写入目标：只列可写（owner/writer）
        const writeSel = document.getElementById('writeCal');
        writeSel.innerHTML = '';
        const writable = calendarListCache.filter(c => c.accessRole === 'owner' || c.accessRole === 'writer');
        for (const cal of writable) {
          const opt = document.createElement('option');
          opt.value = cal.id;
          opt.textContent = cal.summary + (cal.primary ? " (primary)" : "");
          writeSel.appendChild(opt);
        }
        const primary = writable.find(c => c.primary);
        writeCalendarId = primary ? primary.id : (writable[0]?.id || 'primary');
        writeSel.value = writeCalendarId;
        document.getElementById('currCal').textContent = writeCalendarId;
        writeSel.style.display = '';
        writeSel.onchange = () => {
          writeCalendarId = writeSel.value;
          document.getElementById('currCal').textContent = writeCalendarId;
        };

        // “显示哪些日历”：列出所有可见（含只读），默认全选
        const picker = document.getElementById('picker');
        const listDiv = document.getElementById('calList');
        const legend = document.getElementById('legend');
        listDiv.innerHTML = '';
        legend.innerHTML = '';
        showCalendarIds = new Set(calendarListCache.map(c => c.id)); // 默认全选
        for (const cal of calendarListCache) {
          // 勾选项
          const wrap = document.createElement('label');
          wrap.className = 'item';
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.checked = true;
          cb.value = cal.id;
          cb.onchange = () => {
            if (cb.checked) showCalendarIds.add(cal.id);
            else showCalendarIds.delete(cal.id);
            if (calendar) calendar.refetchEvents();
          };
          const sw = document.createElement('span'); sw.className = 'sw'; sw.style.background = cal.backgroundColor || '#bbb';
          const txt = document.createElement('span'); txt.textContent = cal.summary + (cal.accessRole === 'reader' ? '（只读）' : '');
          wrap.appendChild(cb); wrap.appendChild(sw); wrap.appendChild(txt);
          listDiv.appendChild(wrap);

          // 图例
          const pill = document.createElement('span');
          pill.className = 'pill';
          const sw2 = document.createElement('span'); sw2.className = 'sw'; sw2.style.background = cal.backgroundColor || '#bbb';
          const name = document.createElement('span'); name.textContent = cal.summary;
          pill.appendChild(sw2); pill.appendChild(name);
          legend.appendChild(pill);
        }
        picker.style.display = '';

        // 全选/全不选
        document.getElementById('checkAll').onclick = () => {
          showCalendarIds = new Set(calendarListCache.map(c => c.id));
          listDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
          if (calendar) calendar.refetchEvents();
        };
        document.getElementById('uncheckAll').onclick = () => {
          showCalendarIds = new Set();
          listDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
          if (calendar) calendar.refetchEvents();
        };

      } catch (e) {
        showDiag(e);
      }

      renderCalendar();
    }

    // —— 渲染日历 ——
    function renderCalendar() {
      const el = document.getElementById('calendar');
      if (calendar) calendar.destroy();

      calendar = new FullCalendar.Calendar(el, {
        initialView: 'timeGridWeek',
        timeZone: TIMEZONE,
        firstDay: 1,                // 周一为第一天
        slotMinTime: "08:00:00",    // 早上 8 点开始
        slotMaxTime: "24:00:00",    // 晚上 12 点结束
        scrollTime: "08:00:00",     // 打开后滚到 8 点
        selectable: true,
        editable: true,
        nowIndicator: true,
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },

        // 拉取被“勾选用于显示”的全部日历（含只读）
        events: async (info, success, failure) => {
          try {
            const timeMin = new Date(info.start).toISOString();
            const timeMax = new Date(info.end).toISOString();

            // 如果一个都没选，为了避免空白，至少显示“写入目标”
            const ids = (showCalendarIds.size ? Array.from(showCalendarIds) : [writeCalendarId]);

            const fetchOne = async (cid) => {
              const res = await gapi.client.calendar.events.list({
                calendarId: cid,
                timeMin, timeMax,
                singleEvents: true,
                orderBy: 'startTime',
                showDeleted: false,
                maxResults: 2500,
              });
              const meta = calendarListCache.find(x => x.id === cid);
              const color = meta?.backgroundColor;
              const canEdit = meta && (meta.accessRole === 'owner' || meta.accessRole === 'writer');

              return (res.result.items || []).map(ev => ({
                id: ev.id || Math.random().toString(36).slice(2),
                title: ev.summary || '(无标题)',
                start: ev.start.dateTime || ev.start.date,
                end: ev.end?.dateTime || ev.end?.date,
                allDay: !!ev.start.date,
                backgroundColor: color,
                borderColor: color,
                // **关键**：把 calendarId 和 eventId 放在 extendedProps，供更新/删除使用
                extendedProps: { calendarId: cid, eventId: ev.id, canEdit }
              }));
            };

            const chunks = await Promise.all(ids.map(cid => fetchOne(cid)));
            success(chunks.flat());
          } catch (err) {
            showDiag(err);
            failure(err);
          }
        },

        // 只允许编辑“可编辑的事件”
        eventAllow: function(dropInfo, draggedEvent) {
          const canEdit = draggedEvent.extendedProps?.canEdit;
          if (!canEdit) {
            alert('这是只读日历的事件，不能编辑。');
            return false;
          }
          return true;
        },

        // 新建事件：始终写到“写入目标”
        select: async (selInfo) => {
          const title = prompt('事件标题：', '新事件');
          if (!title) { calendar.unselect(); return; }
          const isAllDay = selInfo.allDay;
          const resource = {
            summary: title,
            start: isAllDay ? { date: selInfo.startStr } : { dateTime: selInfo.startStr, timeZone: TIMEZONE },
            end:   isAllDay ? { date: selInfo.endStr }   : { dateTime: selInfo.endStr,   timeZone: TIMEZONE },
          };
          try {
            const res = await gapi.client.calendar.events.insert({ calendarId: writeCalendarId, resource });
            const ev = res.result;
            const meta = calendarListCache.find(x => x.id === writeCalendarId);
            const color = meta?.backgroundColor;
            // 仅当写入目标被勾选用于显示时，才即时添加到视图（否则等下次勾选/刷新）
            if (showCalendarIds.has(writeCalendarId)) {
              calendar.addEvent({
                id: ev.id,
                title: ev.summary || '(无标题)',
                start: ev.start.dateTime || ev.start.date,
                end: ev.end?.dateTime || ev.end?.date,
                allDay: !!ev.start.date,
                backgroundColor: color,
                borderColor: color,
                extendedProps: { calendarId: writeCalendarId, eventId: ev.id, canEdit: true }
              });
            }
          } catch (e) {
            showDiag(e);
            alert('创建失败：' + (e.result?.error?.message || e.message));
          }
        },

        // 修改事件（只有可编辑事件能走到这里）
        eventChange: async (chg) => {
          const e = chg.event;
          const { calendarId, eventId, canEdit } = e.extendedProps || {};
          if (!canEdit) { chg.revert(); return; }

          try {
            await gapi.client.calendar.events.update({
              calendarId,
              eventId,
              resource: {
                summary: e.title,
                start: e.allDay ? { date: e.startStr } : { dateTime: e.start.toISOString(), timeZone: TIMEZONE },
                end:   e.allDay ? { date: e.endStr   } : { dateTime: e.end?.toISOString(),  timeZone: TIMEZONE },
              }
            });
          } catch (err) {
            showDiag(err);
            alert('更新失败，已回滚：' + (err.result?.error?.message || err.message));
            chg.revert();
          }
        },

        // 点击删除（只读事件在 eventAllow 已拦下）
        eventClick: async (clickInfo) => {
          const { calendarId, eventId, canEdit } = clickInfo.event.extendedProps || {};
          if (!canEdit) { alert('这是只读日历的事件，不能删除。'); return; }
          if (!confirm('删除这个事件？')) return;

          try {
            await gapi.client.calendar.events.delete({ calendarId, eventId });
            // 与服务器强一致：删除后强制刷新（避免本地状态与服务器不同步）
            clickInfo.event.remove();
            calendar.refetchEvents();
          } catch (err) {
            showDiag(err);
            alert('删除失败：' + (err.result?.error?.message || err.message));
          }
        }
      });

      calendar.render();
    }

    // 初始化回调
    window.onload = () => {
      if (window.gapi) gapiLoaded();
      if (window.google) gisLoaded();
    };
  </script>
</body>
</html>
