<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>内部用 · Google Calendar 日历（GitHub Pages 纯前端）</title>

  <!-- FullCalendar v6 -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>

  <!-- Google Identity Services + Google API JS -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>

  <style>
    :root { --border:#e5e7eb; --bg:#f8fafc; --text:#111827; --muted:#6b7280; }
    * { box-sizing: border-box; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center;padding:10px 14px;z-index:10}
    #calendar{max-width:1100px;margin:16px auto;padding:0 12px}
    button{padding:8px 12px;border:1px solid var(--border);border-radius:8px;background:#fff;cursor:pointer}
    .right{margin-left:auto;display:flex;gap:8px;align-items:center}
    .help{font-size:12px;color:var(--muted)}
    .footer{max-width:1100px;margin:16px auto;padding:0 12px 24px;color:var(--muted);font-size:12px}
    .chip{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;background:#fff;font-size:12px;color:#374151}
    .title{font-weight:600;margin-right:6px}
    select{padding:6px 8px;border:1px solid var(--border);border-radius:8px;background:#fff}
    label.switch{display:flex;align-items:center;gap:6px}
    .diag{max-width:1100px;margin:8px auto 0;padding:8px 12px;border:1px dashed var(--border);background:#fff; border-radius:10px; color:#374151}
    .diag b{color:#111}
    .diag pre{white-space:pre-wrap;word-break:break-word;margin:6px 0 0;font-size:12px;color:#6b7280}
  </style>
</head>
<body>
  <header>
    <span class="title">内部日历</span>
    <span class="chip">纯前端 · GitHub Pages</span>
    <div class="right">
      <button id="signin">使用 Google 登录</button>
      <button id="signout" style="display:none;">退出</button>
      <span id="status" class="help">未登录</span>
      <select id="calId" title="选择写入日历（默认 primary）" style="display:none;"></select>
      <label id="mergeWrap" class="switch help" style="display:none;">
        <input type="checkbox" id="mergeAll" />
        合并显示全部
      </label>
    </div>
  </header>

  <div id="calendar"></div>

  <div class="diag" id="diag" style="display:none;">
    <b>诊断</b>
    <pre id="diagText"></pre>
  </div>

  <div class="footer">
    <div>时区：<code id="tzLabel">America/Toronto</code>　当前写入日历：<code id="currCal">primary</code></div>
    <p class="help">提示：需要在 Google Cloud 的 OAuth 客户端把本地/线上域名加入 Authorized JavaScript origins；共享日历须给你的账号“可更改事件”权限才能写入。合并显示开启时，会同时拉取你可见的所有日历（包括只读订阅日历），仅用于查看。</p>
  </div>

  <script>
    // ======= 替换为你的 Google Web Client ID（Web 应用） =======
    const CLIENT_ID = "126117723960-3gdibqblicp6ncc0jiuv9pu8frgmhs5n.apps.googleusercontent.com";

    // 读取日历列表（含只读）+ 写事件（最小必要组合）
    const SCOPES = "https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/calendar.events";

    const DEFAULT_CALENDAR_ID = "primary";
    const TIMEZONE = "America/Toronto";

    let tokenClient, accessToken = null, gapiReady = false, gisReady = false, calendar;
    let calendarListCache = []; // 你可见的所有日历（含只读）

    // —— 小工具：诊断输出 ——
    function showDiag(obj) {
      const box = document.getElementById('diag');
      const pre = document.getElementById('diagText');
      box.style.display = '';
      try {
        pre.textContent = (typeof obj === 'string') ? obj : JSON.stringify(obj, null, 2);
      } catch(e) {
        pre.textContent = String(obj);
      }
    }

    function gapiLoaded() {
      gapi.load('client', async () => {
        await gapi.client.init({
          discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
        });
        gapiReady = true;
      });
    }
    window.gapiLoaded = gapiLoaded;

    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (resp) => {
          if (resp && resp.access_token) {
            accessToken = resp.access_token;
            // **关键：把 token 灌进 gapi**
            gapi.client.setToken({ access_token: accessToken });
            onSignedIn();
          } else {
            showDiag({oauth_callback_resp: resp});
          }
        },
      });
      gisReady = true;
    }
    window.gisLoaded = gisLoaded;

    async function signIn() {
      if (!gapiReady || !gisReady) return;
      tokenClient.requestAccessToken({ prompt: 'consent' });
    }

    function signOut() {
      if (!accessToken) return;
      google.accounts.oauth2.revoke(accessToken, () => {
        accessToken = null;
        gapi.client.setToken(null);
        document.getElementById('signin').style.display = '';
        document.getElementById('signout').style.display = 'none';
        document.getElementById('status').textContent = '未登录';
        document.getElementById('calId').style.display = 'none';
        document.getElementById('mergeWrap').style.display = 'none';
        document.getElementById('currCal').textContent = 'primary';
        if (calendar) calendar.destroy();
      });
    }

    document.getElementById('signin').onclick = signIn;
    document.getElementById('signout').onclick = signOut;
    document.getElementById('tzLabel').textContent = TIMEZONE;

    // —— 登录后：拉日历列表 ——
    async function onSignedIn() {
      document.getElementById('signin').style.display = 'none';
      document.getElementById('signout').style.display = '';
      document.getElementById('status').textContent = '已登录';

      const sel = document.getElementById('calId');
      const mergeWrap = document.getElementById('mergeWrap');
      const mergeAll = document.getElementById('mergeAll');

      sel.innerHTML = '';
      try {
        const res = await gapi.client.calendar.calendarList.list({ maxResults: 250 });
        calendarListCache = (res.result.items || []);

        const writable = calendarListCache.filter(c => c.accessRole === 'owner' || c.accessRole === 'writer');
        for (const cal of writable) {
          const opt = document.createElement('option');
          opt.value = cal.id;
          opt.textContent = cal.summary + (cal.primary ? " (primary)" : "");
          sel.appendChild(opt);
        }
        const primary = writable.find(c => c.primary);
        sel.value = primary ? primary.id : (writable[0]?.id || 'primary');
        sel.style.display = '';
        mergeWrap.style.display = '';

      } catch (e) {
        showDiag(e);
        const opt = document.createElement('option');
        opt.value = 'primary'; opt.textContent = 'Primary';
        sel.appendChild(opt);
        sel.style.display = '';
        mergeWrap.style.display = 'none';
      }

      sel.onchange = () => { if (calendar) { calendar.destroy(); renderCalendar(sel.value); } };
      mergeAll.onchange = () => { if (calendar) { calendar.refetchEvents(); } };

      renderCalendar(sel.value || DEFAULT_CALENDAR_ID);
    }

    // —— 渲染日历 ——
    function renderCalendar(calendarId) {
      document.getElementById('currCal').textContent = calendarId;
      const el = document.getElementById('calendar');

      calendar = new FullCalendar.Calendar(el, {
        initialView: 'timeGridWeek',
        timeZone: TIMEZONE,
        selectable: true,
        editable: true,
        nowIndicator: true,
        slotMinTime: "07:00:00",
        slotMaxTime: "23:00:00",
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },

        // —— 拉事件：强制使用 RFC3339 日期时间（避免 400） + 合并模式 ——
        events: async (info, success, failure) => {
          try {
            const useMerge = document.getElementById('mergeAll')?.checked;
            const timeMin = new Date(info.start).toISOString();
            const timeMax = new Date(info.end).toISOString();

            const fetchOne = async (cid) => {
              const res = await gapi.client.calendar.events.list({
                calendarId: cid,
                timeMin, timeMax,
                singleEvents: true,
                orderBy: 'startTime',
                showDeleted: false,
                maxResults: 2500,
              });
              const meta = calendarListCache.find(x => x.id === cid);
              const color = meta?.backgroundColor;
              return (res.result.items || []).map(ev => ({
                id: (ev.id || Math.random().toString(36).slice(2)) + "::" + cid,
                title: ev.summary || '(无标题)',
                start: ev.start.dateTime || ev.start.date,
                end: ev.end?.dateTime || ev.end?.date,
                allDay: !!ev.start.date,
                backgroundColor: color,
                borderColor: color,
                extendedProps: { gcal: true, calendarId: cid, originalId: ev.id }
              }));
            };

            let merged = [];
            if (useMerge) {
              const allIds = calendarListCache.map(c => c.id);
              const chunks = await Promise.all(allIds.map(cid => fetchOne(cid)));
              merged = chunks.flat();
            } else {
              merged = await fetchOne(calendarId);
            }

            success(merged);
          } catch (err) {
            showDiag(err);
            failure(err);
          }
        },

        // —— 新建事件：写到当前选中的那本文历 ——
        select: async (selInfo) => {
          const title = prompt('事件标题：', '新事件');
          if (!title) { calendar.unselect(); return; }
          const isAllDay = selInfo.allDay;
          const resource = {
            summary: title,
            start: isAllDay ? { date: selInfo.startStr } : { dateTime: selInfo.startStr, timeZone: TIMEZONE },
            end:   isAllDay ? { date: selInfo.endStr }   : { dateTime: selInfo.endStr,   timeZone: TIMEZONE },
          };
          try {
            const res = await gapi.client.calendar.events.insert({ calendarId, resource });
            const ev = res.result;
            const meta = calendarListCache.find(x => x.id === calendarId);
            const color = meta?.backgroundColor;
            calendar.addEvent({
              id: (ev.id || Math.random().toString(36).slice(2)) + "::" + calendarId,
              title: ev.summary || '(无标题)',
              start: ev.start.dateTime || ev.start.date,
              end: ev.end?.dateTime || ev.end?.date,
              allDay: !!ev.start.date,
              backgroundColor: color,
              borderColor: color,
              extendedProps: { gcal: true, calendarId, originalId: ev.id }
            });
          } catch (e) {
            showDiag(e);
            alert('创建失败：' + (e.result?.error?.message || e.message));
          }
        },

        // —— 修改事件：定位正确的日历与事件 ID ——
        eventChange: async (chg) => {
          const e = chg.event;
          const [origId, cid] = (e.id || "").split("::");
          const targetCalId = cid || calendarId;
          const targetEventId = origId || e.id;

          try {
            await gapi.client.calendar.events.update({
              calendarId: targetCalId,
              eventId: targetEventId,
              resource: {
                summary: e.title,
                start: e.allDay ? { date: e.startStr } : { dateTime: e.start.toISOString(), timeZone: TIMEZONE },
                end:   e.allDay ? { date: e.endStr   } : { dateTime: e.end?.toISOString(),  timeZone: TIMEZONE },
              }
            });
          } catch (err) {
            showDiag(err);
            alert('更新失败，已回滚：' + (err.result?.error?.message || err.message));
            chg.revert();
          }
        },

        // —— 删除事件 ——
        eventClick: async (clickInfo) => {
          if (!confirm('删除这个事件？')) return;
          const [origId, cid] = (clickInfo.event.id || "").split("::");
          const targetCalId = cid || calendarId;
          const targetEventId = origId || clickInfo.event.id;

          try {
            await gapi.client.calendar.events.delete({ calendarId: targetCalId, eventId: targetEventId });
            clickInfo.event.remove();
          } catch (err) {
            showDiag(err);
            alert('删除失败：' + (err.result?.error?.message || err.message));
          }
        }
      });

      calendar.render();
    }

    // 初始化回调
    window.onload = () => {
      if (window.gapi) gapiLoaded();
      if (window.google) gisLoaded();
    };
  </script>
</body>
</html>
